(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const a of o)if(a.type==="childList")for(const i of a.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&s(i)}).observe(document,{childList:!0,subtree:!0});function e(o){const a={};return o.integrity&&(a.integrity=o.integrity),o.referrerPolicy&&(a.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?a.credentials="include":o.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(o){if(o.ep)return;o.ep=!0;const a=e(o);fetch(o.href,a)}})();class mt{points;constructor(t=[]){this.points=t}}const it=(n,t)=>`Заданный угол ${n}° прямоугольника ${JSON.stringify(t)} подсоединения не перпендикулярен грани`,j=15,tt=3,at=3,z=8,C=.001,Mt=(n,t)=>n.x*t.y-n.y*t.x,It=(n,t)=>n.x*t.x+n.y*t.y,et=(n,t,e=!1,s=!1)=>{let o=Math.atan2(Mt(n,t),It(n,t));return o<0&&(o+=2*Math.PI),s&&(o=2*Math.PI-o),e?o*180/Math.PI:o},b=(n,t)=>({x:n.x-t.x,y:n.y-t.y}),ct=(n,t)=>({x:n.x*t.x,y:n.y*t.y}),E=(n,t)=>({x:n.x+t.x,y:n.y+t.y}),R=n=>{const t=Math.sqrt(n.x*n.x+n.y*n.y);if(t===0)return T();const e=n.x/t,s=n.y/t;return{x:Math.abs(e)-C<=0?0:Math.abs(e)+C>=1?Math.sign(e)*1:e,y:Math.abs(s)-C<=0?0:Math.abs(s)+C>=1?Math.sign(s)*1:s}},L=(n,t,e=!1,s=!1)=>{const o=s?360:2*Math.PI;let a=t%o;a<0&&(a+=o);const i=s?a*Math.PI/180:a,c=e?-1:1,u=Math.cos(i),f=Math.sin(i)*c;return{x:n.x*u-n.y*f,y:n.x*f+n.y*u}},rt=(n,t)=>{const e=b(t,n);return e.x**2+e.y**2},v=n=>({x:n.x,y:document.documentElement.offsetHeight-n.y});class ht extends Error{constructor(t){super(t),this.name="PointNotOnTheEdgeError"}}class Z extends Error{constructor(t){super(t),this.name="ConnectionPointAngleNotPerpendicularError"}}const lt=(n,t,e)=>{const s=b(t,n),o=b(e,n),a=Math.min(t.x,e.x)-C<=n.x&&n.x<=Math.max(t.x,e.x)+C,i=Math.min(t.y,e.y)-C<=n.y&&n.y<=Math.max(t.y,e.y)+C,c=Mt(s,o);return c>=0&&c<=C&&a&&i},K=(n,t,e=!1)=>{const s=D(n),[o,a,i]=s;let c=Math.min(o.x,i.x)<=t.x&&t.x<=Math.max(o.x,i.x),u=Math.min(o.y,i.y)<=t.y&&t.y<=Math.max(o.y,i.y);return e&&(c=Math.min(o.x,i.x)<t.x&&t.x<Math.max(o.x,i.x),u=Math.min(o.y,i.y)<t.y&&t.y<Math.max(o.y,i.y)),c&&u},k=(n,t)=>{const[e,s]=n,[o,a]=t,i={x:s.x-e.x,y:s.y-e.y},c={x:a.x-o.x,y:a.y-o.y},u=i.x*c.y-i.y*c.x;if(u===0){if(!(e.x*(s.y-o.y)+s.x*(o.y-e.y)+o.x*(e.y-s.y)===0))return null;const l=((o.x-e.x)*i.x+(o.y-e.y)*i.y)/(i.x*i.x+i.y*i.y),d=((a.x-e.x)*i.x+(a.y-e.y)*i.y)/(i.x*i.x+i.y*i.y),m=Math.min(l,d),x=Math.max(l,d);if(x<0||m>1)return null;const p=Math.max(0,m),y=Math.min(1,x);if(p===y){const M=e.x+p*i.x,P=e.y+p*i.y;return{x:M,y:P}}else{const M={x:e.x+p*i.x,y:e.y+p*i.y},P={x:e.x+y*i.x,y:e.y+y*i.y};return[M,P]}}const f=((e.y-o.y)*c.x-(e.x-o.x)*c.y)/u,g=-((e.y-o.y)*i.x-(e.x-o.x)*i.y)/u;if(f>=0&&f<=1&&g>=0&&g<=1){const h=e.x+f*i.x,l=e.y+f*i.y;return{x:h,y:l}}return null};function St(n,t,e,s,o){const a=n[t],i=n[e],c=Ot(n,s,o),u=new Map,f=new Map,g=new Set;u.set(`${a.x},${a.y}`,0),f.set(`${a.x},${a.y}`,null);const h=[{...a,dist:0}];for(;h.length>0;){h.sort((x,p)=>x.dist-p.dist);const l=h.shift(),d=`${l.x},${l.y}`;if(g.has(d))continue;if(g.add(d),l.x===i.x&&l.y===i.y)return{path:zt(f,i),distance:u.get(d)};const m=c.get(d)||[];for(const x of m){const p=`${x.x},${x.y}`,y=u.get(d)+jt(l,x);y<(u.get(p)??1/0)&&(u.set(p,y),f.set(p,l),h.push({...x,dist:y}))}}return{path:[],distance:1/0}}function jt(n,t){return Math.abs(n.x-t.x)+Math.abs(n.y-t.y)}function zt(n,t){const e=[];let s=`${t.x},${t.y}`,o=n.get(s);for(;o;)e.unshift({x:o.x,y:o.y}),s=`${o.x},${o.y}`,o=n.get(s);return e.push({x:t.x,y:t.y}),e}function Ot(n,t,e){const s=new Map,o=w(t),a=w(e);for(let i=0;i<n.length;i++){const c=n[i],u=`${c.x},${c.y}`;s.set(u,[]);const f=n.filter(h=>h.x===c.x&&h.y!==c.y);f.sort((h,l)=>h.y-l.y);for(const h of f){let l=0;for(const d of o){const m=B(h,c,[d]),x=k(d,[h,c]);m&&!x&&(l+=1)}for(const d of a){const m=B(h,c,[d]),x=k(d,[h,c]);m&&!x&&(l+=1)}l<=1&&s.get(u).push(h)}const g=n.filter(h=>h.y===c.y&&h.x!==c.x);g.sort((h,l)=>h.x-l.x);for(const h of g){let l=0;for(const d of o){const m=B(h,c,[d]),x=k(d,[h,c]);m&&!x&&(l+=1)}for(const d of a){const m=B(h,c,[d]),x=k(d,[h,c]);m&&!x&&(l+=1)}l<=1&&s.get(u).push(h)}}return s}const Wt=(n,t,e,s)=>{const{x:o,y:a}=n,{x:i,y:c}=t,{x:u,y:f}=e,{x:g,y:h}=s,l=i-o,d=c-a,m=g-u,x=h-f,p=l*x-d*m;if(Math.abs(p)<C)return null;const y=u-o,M=f-a,P=(y*x-M*m)/p,I=(y*d-M*l)/p;return P>=0&&P<=1&&I>=0&&I<=1?{x:o+P*l,y:a+P*d}:null},B=(n,t,e)=>{const{x:s,y:o}=n;let a=null,i=1/0;for(const c of e){const[u,f]=c,g=Wt(n,t,u,f);if(g){const h=g.x-s,l=g.y-o,d=h*h+l*l;d<i&&(i=d,a={point:g,segment:c})}}return a},D=({position:n,size:t})=>{const e=t.width/2,s=t.height/2,o={x:n.x-e,y:n.y+s},a={x:n.x+e,y:n.y+s},i={x:n.x-e,y:n.y-s},c={x:n.x+e,y:n.y-s};return[o,a,c,i]},dt=(n,t)=>Math.abs(n.x-t.x)<C&&Math.abs(n.y-t.y)<C,ut=(n,t,e,s)=>{const o=w(n),a=w(t);let i=!1,c=o[0];for(const r of o){const[S,A]=r;if(lt(e.point,S,A)){i=!0,c=r;break}}if(!i)throw new ht("Точка 1 не лежит ни на одной грани");let u=!1,f=a[0];for(const r of a){const[S,A]=r;if(lt(s.point,S,A)){u=!0,f=r;break}}if(!u)throw new ht("Точка 2 не лежит ни на одной грани");if(e.angle%90!==0)throw new Z(`Заданный угол ${e.angle}° первого прямоугольника подсоединения не перпендикулярен грани`);if(s.angle%90!==0)throw new Z(`Заданный угол ${s.angle}° второго прямоугольника подсоединения не перпендикулярен грани`);const g={x:1,y:0},h=R(b(c[1],c[0]));let l=R(L(h,90,!1,!0)),d=et(g,l,!0,!1);if(d!==e.angle&&!xt(e.point,n))throw new Z(it(e.angle,n));const m=R(b(f[1],f[0]));if(l=R(L(m,90,!1,!0)),d=et(g,l,!0,!1),d!==s.angle&&!xt(s.point,t))throw new Z(it(s.angle,t));const x={x:1,y:0},p={x:j,y:j},y=E(ct(R(L(x,e.angle,!1,!0)),p),e.point),M=E(ct(R(L(x,s.angle,!1,!0)),p),s.point),P=b(M,y),I={size:{width:n.size.width+2*j,height:n.size.height+2*j},position:n.position},F={size:{width:t.size.width+2*j,height:t.size.height+2*j},position:t.position},q=D(I),Pt=w(I),H=D(F),Nt=w(F),O=Math.min(...q.map(r=>r.x),...H.map(r=>r.x)),_=Math.max(...q.map(r=>r.x),...H.map(r=>r.x)),W=Math.min(...q.map(r=>r.y),...H.map(r=>r.y)),U=Math.max(...q.map(r=>r.y),...H.map(r=>r.y)),nt=rt(y,T()),ot=rt(y,T()),X=nt<ot?y:M,Y=nt<ot?M:y,Ct={position:{x:(X.x+_)/2,y:(X.y+U)/2},size:{width:Math.abs(X.x-_),height:Math.abs(X.y-U)}},wt={position:{x:(Y.x+O)/2,y:(Y.y+W)/2},size:{width:Math.abs(Y.x-O),height:Math.abs(Y.y-W)}},Et=w(Ct),bt=w(wt),st=b({x:O,y:W},{x:_,y:U}),vt={position:{x:O+Math.abs(st.x/2),y:W+Math.abs(st.y/2)},size:{width:_-O,height:U-W}},Tt=w(vt),At={position:{x:Math.min(y.x,M.x)+Math.abs(P.x/2),y:Math.min(y.y,M.y)+Math.abs(P.y/2)},size:{width:Math.abs(P.x),height:Math.abs(P.y)}},Rt=w(At),$=[...Pt,...Nt,...Rt,...Tt,...Et,...bt],G=[];for(let r=0;r<$.length;r++){const S=$[r];for(let A=0;A<$.length;A++){if(S===$[A])continue;const V=k(S,$[A]);if(Array.isArray(V)){G.push(...V);continue}V&&G.push(V)}}const J=[...new Map(G.map(r=>[`${r.x},${r.y}`,r])).values()].filter(r=>dt(y,r)||dt(M,r)||!K(I,r,!0)&&!K(F,r,!0)),{path:Dt}=St(J,J.findIndex(r=>r.x===y.x&&r.y===y.y),J.findIndex(r=>r.x===M.x&&r.y===M.y),ft(I,-tt/2),ft(F,-tt/2));return[e.point,...Dt,s.point]},ft=(n,t)=>({...n,size:{width:n.size.width+t,height:n.size.height+t}}),w=n=>{const t=D(n);return[[t[0],t[1]],[t[1],t[2]],[t[2],t[3]],[t[3],t[0]]]},Q=n=>n.x===0&&n.y===0,T=()=>({x:0,y:0}),xt=(n,t)=>{const e=D(t);for(const s of e)if(n.x===s.x&&n.y===s.y)return!0;return!1};class yt extends mt{rect={size:{width:1,height:1},position:{x:1,y:1}};constructor(t){super(D(t)),this.rect=t}}class $t{points;constructor(t=[]){this.points=t}}class gt{shape;adjacentNode=null;pathToAdjacentNode=null;constructor(t,e,s){this.shape=t,this.adjacentNode=e,this.pathToAdjacentNode=s}assignTranslation(t,e){this.shape instanceof N&&(t&&(this.shape.translation=t),e&&(this.shape.connectionPointTranslation=e))}initializePathToAdjecentNode(){if(this.adjacentNode&&this.shape instanceof N&&this.adjacentNode.shape instanceof N){const t=new pt(ut(this.shape.model.rect,this.adjacentNode.shape.model.rect,this.shape.connectionPoint,this.adjacentNode.shape.connectionPoint),"#3f9");this.pathToAdjacentNode=t,this.adjacentNode.pathToAdjacentNode=t}}createAdjacentNodePathWithTranslations(){if(this.adjacentNode&&this.shape instanceof N&&this.adjacentNode.shape instanceof N){const t={point:E(this.shape.connectionPoint.point,this.shape.translation),angle:this.shape.connectionPoint.angle},e={...E(this.shape.model.rect.position,this.shape.translation)};Q(this.shape.connectionPointTranslation)||this.calculateMouseFromCenterEdgeIntersection();const s=new pt(ut({...this.shape.model.rect,position:e},this.adjacentNode.shape.model.rect,t,this.adjacentNode.shape.connectionPoint),"#3f9");this.pathToAdjacentNode=s,this.adjacentNode.pathToAdjacentNode=s}}calculateMouseFromCenterEdgeIntersection(){if(this.adjacentNode&&this.shape instanceof N&&this.adjacentNode.shape instanceof N){const t=B(E(this.shape.model.rect.position,this.shape.connectionPointTranslation),this.shape.model.rect.position,w(this.shape.model.rect));let e=this.shape.connectionPoint.angle;if(t){const s=R(L(R(b(t.segment[1],t.segment[0])),90,!1,!0));e=et({x:1,y:0},s,!0);const o={point:t.point,angle:e};o.point.x=Math.round(o.point.x),o.point.y=Math.round(o.point.y),this.shape.connectionPoint=o}}}commitTranslation(){if(this.shape instanceof N){const t={point:E(this.shape.connectionPoint.point,this.shape.translation),angle:this.shape.connectionPoint.angle},e={...E(this.shape.model.rect.position,this.shape.translation)};Q(this.shape.translation)||(this.shape.model.rect.position=e,this.shape.connectionPoint.point=t.point,this.shape.model.points=D(this.shape.model.rect),this.shape.points=D(this.shape.model.rect)),Q(this.shape.connectionPointTranslation)||this.calculateMouseFromCenterEdgeIntersection(),this.shape.translation=T(),this.shape.connectionPointTranslation=T()}}}class Lt extends mt{bgColor="#000";translation=T();draw(t){const{x:e,y:s}=v(E(this.points[0],this.translation));t.beginPath(),t.moveTo(e,s);for(let o=1;o<this.points.length;o++){const{x:a,y:i}=v(E(this.points[o],this.translation));t.lineTo(a,i)}t.fillStyle=this.bgColor,t.fill()}}class N extends Lt{borderColor="#000";connectionPointColor="#3ef";connectionPoint;model;connectionPointTranslation=T();constructor(t,e,s,o,a){super(t.points),this.borderColor=o,this.bgColor=s,this.connectionPointColor=a,this.connectionPoint=e,this.model=t}draw(t){const e={width:this.model.rect.size.width+at,height:this.model.rect.size.height+at},s=v(E(this.model.rect.position,this.translation));t.fillStyle=this.borderColor,t.fillRect(s.x-e.width/2,s.y-e.height/2,e.width,e.height),super.draw(t);const o=v(E(this.connectionPoint.point,this.translation));t.fillStyle=this.connectionPointColor,t.fillRect(o.x-z/2,o.y-z/2,z,z)}}class pt extends $t{color;constructor(t,e){super(t),this.color=e}draw(t){const{x:e,y:s}=v(this.points[0]);t.beginPath(),t.moveTo(e,s);for(let o=1;o<this.points.length;o++){const{x:a,y:i}=v(this.points[o]);t.lineTo(a,i)}t.lineWidth=tt,t.strokeStyle=this.color,t.stroke()}}class kt{mouseDownCallbacks=[];mouseUpCallbacks=[];mouseMoveCallbacks=[];constructor(){}initialize(){}addMouseDownCallback(t){this.mouseDownCallbacks.push(t),document.addEventListener("mousedown",t)}addMouseMoveCallback(t){this.mouseDownCallbacks.push(t),document.addEventListener("mousemove",t)}addMouseUpCallback(t){this.mouseDownCallbacks.push(t),document.addEventListener("mouseup",t)}clearCallbacks(){for(const t of this.mouseDownCallbacks)document.removeEventListener("mousedown",t);for(const t of this.mouseUpCallbacks)document.removeEventListener("mouseup",t);for(const t of this.mouseMoveCallbacks)document.removeEventListener("mousemove",t)}}class Bt{canvas;areaNodes=[];selectedNode=null;selectedConnectionPointNode=null;inputService;mouseDownCoordinates=null;rafID=-1;constructor(){this.inputService=new kt}init(){const t=document.querySelector("#canvas"),e=document.documentElement.offsetWidth,s=document.documentElement.offsetHeight;if(t)this.canvas=document.querySelector("#canvas"),this.canvas.width=e,this.canvas.height=s;else throw new Error("Canvas элемент не инициализирован");const o=50,a=50,i=50,c=50,u={x:Math.round(e/2),y:Math.round(s/2)+150},f={x:Math.round(e/2),y:Math.round(s/2)-100},g=new N(new yt({position:{...u},size:{width:o,height:a}}),{point:{x:u.x+o/2,y:u.y},angle:0},"#afa","#33f","#000"),h=new N(new yt({position:{...f},size:{width:i,height:c}}),{point:{x:f.x,y:f.y-c/2},angle:270},"#afa","#33f","#000"),l=new gt(h,null,null),d=new gt(g,l,null);l.adjacentNode=d,d.initializePathToAdjecentNode(),this.areaNodes.push(d,l),this.inputService.addMouseDownCallback(this.onMouseDownAreaNodeSelect.bind(this)),this.inputService.addMouseMoveCallback(this.onMouseMoveSelectedAreaNode.bind(this)),this.inputService.addMouseUpCallback(this.onMouseUpAreaNodeSelect.bind(this))}start(){this.rafID=requestAnimationFrame(this.render.bind(this))}render(){if(typeof this.canvas<"u"){const t=this.canvas.getContext("2d");if(this.canvas&&typeof t<"u"&&t!==null){t.clearRect(0,0,document.documentElement.offsetWidth,document.documentElement.offsetHeight);for(const e of this.areaNodes)e.adjacentNode&&e.pathToAdjacentNode&&e.pathToAdjacentNode.draw(t);for(const e of this.areaNodes)e.shape.draw(t)}}}onMouseDownAreaNodeSelect(t){const e=v({x:t.clientX,y:t.clientY});for(const s of this.areaNodes)if(s.shape instanceof N){const o={position:s.shape.connectionPoint.point,size:{width:z,height:z}};if(K(o,e)){this.selectedConnectionPointNode=s,this.mouseDownCoordinates=e;return}K(s.shape.model.rect,e)&&(this.selectedNode=s,this.mouseDownCoordinates=e)}}onMouseMoveSelectedAreaNode(t){if(this.mouseDownCoordinates){if(this.selectedNode){const e=v({x:t.clientX,y:t.clientY}),s=b(e,this.mouseDownCoordinates);this.selectedNode.assignTranslation(s,T()),this.selectedNode.createAdjacentNodePathWithTranslations(),this.rafID=requestAnimationFrame(this.render.bind(this))}if(this.selectedConnectionPointNode&&this.selectedConnectionPointNode.shape instanceof N){const e=v({x:t.clientX,y:t.clientY}),s=b(e,this.selectedConnectionPointNode.shape.model.rect.position);this.selectedConnectionPointNode.assignTranslation(T(),s),this.selectedConnectionPointNode.createAdjacentNodePathWithTranslations(),this.rafID=requestAnimationFrame(this.render.bind(this))}}}onMouseUpAreaNodeSelect(){this.selectedNode&&this.selectedNode.commitTranslation(),this.selectedConnectionPointNode&&this.selectedConnectionPointNode.commitTranslation(),this.selectedNode=null,this.selectedConnectionPointNode=null,this.mouseDownCoordinates=null}}document.addEventListener("DOMContentLoaded",()=>{const n=new Bt;n.init(),n.start()});
